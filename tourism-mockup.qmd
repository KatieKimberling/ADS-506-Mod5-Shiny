---
title: "Australian Tourism Forecast"
format: html
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(fpp3)
library(gt)
```

## Tab 1 - Visualize Data
### Data imort / preparation
* Inputs - multiselect for Purpose
* Train date cutoff - default ot 1 yaer prio to the max date

```{r}
# aggregate into Purpose
data("tourism")
data <- tourism |>
  group_by(Purpose) |>
  summarise(Trips = sum(Trips, na.rm = TRUE), .groups = "drop")

# create training cutoff and split data
train_cutoff <- yearquarter("2017 Jan 01")
```

### Data visualization
Give the user the ability to select one or more purposes to visualize in our app
```{r}
# visualize the data with autoplot and facets by purpose
data_trn <- data |>
    filter(Quarter < train_cutoff)

data |>
    autoplot(Trips) +
    geom_vline(xintercept = as.Date(train_cutoff), linetype = "dashed", color = "red", size = 0.6) +
    labs(y = "Trips", title = "Tourism data") +
    facet_wrap(vars(Purpose), ncol = 1, scales = "free_y") +
    theme_minimal()
```

## Tab 2 - Model Building
Inputs:
* Toggle for model specification (default off)
* Toggle the training accuracy (default off)

### Model fitting
Build multiple models for the Purpose series using Auto ARIMA and ETS
This is a second area or tab for our app
```{r}
# fit an ETS model by purpose
fit <- data_trn |>
    model(
        arima = ARIMA(Trips),
        ets = ETS(Trips)
    )
fit # output the model specification
```

### Training accuracy
```{r}
fit |>
    accuracy() |>
    select(Purpose, .model, RMSE, MAE, MAPE) |>
    arrange(.model, MAPE) |>
    gt() |> fmt_number(
        columns = c(RMSE, MAE, MAPE),
        decimals = 2
    )
```

### Forcast accuracy
```{r}
fc <- fit |>
    forecast(h = "1 year")
fc |>
    accuracy(data) |>
    select(Purpose, .model, RMSE, MAE, MAPE) |>
    arrange(.model, MAPE) |>
    gt() |> fmt_number(decimals = 2)
```

### Tab 3
Iputs:
* User can select model for forecast table

### Forecasts visualization
The third tab in our Shiny app - outputting visualizations of the forecasts
```{r}
trn_start <- yearquarter( train_cutoff |> as.Date() - years(2) )
fc |>
    autoplot(data |> filter(Quarter >= trn_start)) +
    labs(y = "Trips", title = "Tourism data forecasts") +
    facet_grid(Purpose ~ .model, scales = "free_y") +
    geom_vline(xintercept = as.Date(train_cutoff), linetype = "dashed", color = "red", size = 0.6) +
    theme_minimal()
```
